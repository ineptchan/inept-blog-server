name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: inept_blog
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      SPRING_PROFILES_ACTIVE: ci
      MINIO_ENDPOINT: http://localhost:9000/
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123456
      MINIO_BUCKET: inept-blog

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x gradlew

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER="${MINIO_ACCESS_KEY}" \
            -e MINIO_ROOT_PASSWORD="${MINIO_SECRET_KEY}" \
            quay.io/minio/minio server /data --console-address ":9001"

      - name: Wait for MinIO
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:9000/minio/health/ready >/dev/null; then
              echo "MinIO is ready"
              exit 0
            fi
            sleep 2
          done
          echo "MinIO not ready in time"
          exit 1

      - name: Create MinIO bucket (optional)
        run: |
          curl -sSL https://dl.min.io/client/mc/release/linux-amd64/mc -o mc
          chmod +x mc
          sudo mv mc /usr/local/bin/mc

          mc alias set local http://localhost:9000 "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
          mc mb -p "local/$MINIO_BUCKET" || true
          mc anonymous set download local/$MINIO_BUCKET/public

      - name: Build and test
        run: ./gradlew build --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: inept-blog-server-jars
          path: build/libs/*.jar
          if-no-files-found: error

      - name: Generate openApi docs
        run: ./gradlew generateOpenApiDocs

      - name: Upload openapi docs
        uses: actions/upload-artifact@v4
        with:
          name: openapi
          path: build/openapi.yaml
          if-no-files-found: warn